#!/usr/bin/env perl

use Math::BaseCnv;
use experimental 'smartmatch';
use Getopt::Std;
use File::Temp qw(tempdir tempfile);

BEGIN {
    getopts 'dt';
    $base = shift // die "USAGE: $0 [-dt] BASE [number].\n";
    *arg = @ARGV ? \&CORE::shift : \&CORE::readline;
}

my %power_of = ( K => 1, M => 2, G => 3, T => 4 );
my $suffix_base = $opt_t ? 1000 : 1024;

while (defined($_ = arg)) {
    chomp;
    s/[,_](?!\d+$)//g;
    $_ .= s/%//    ? ''
        : s/^0b//  ? '%2'
        : s/^0x//  ? '%16'
        : s/^0o?// ? '%8'
        :            '%10'
        ;

    s/(.*?)([KMGT])/$1*($suffix_base**$power_of{$2})/gie;
    s/(.*?)(?=%\d+)/$1/gee;

    $_ = length if s/%1$//;
    $num = reverse cnv((split /%/) => $base);
    $num =~ s/(...)(?=.)/$1,/g  if $opt_d && $base == 10;
    $num =~ s/(....)(?=.)/$1_/g if $opt_d && $base ~~ [2,8,16];
    print scalar reverse($num), "\n";
}

